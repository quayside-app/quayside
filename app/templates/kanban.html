{% extends "project.html" %}
{% load static %}
{% block projectContent %}


{% comment %} <head>
    <!-- TODO use npm nodemanager instead of the headers -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head> {% endcomment %}

{% block taskContent %}{% endblock %}
{% block editProjectContent %}{% endblock %}

<div class = 'text-white'>

  <div id="kanbanBoards" class='justify-center w-full'>

    <div id="columns" class="flex overflow-hidden overflow-x-auto  px-4 w-full text-xs sm:text-xl"></div>

  </div>
  
</div> 


<script>
  (async function () {
    try {
      const response = await fetch('{{ apiUrl }}/kanban/?projectID={{projectID}}');
  
      if (!response.ok) throw new Error('Network response was not ok');
      const kanbanTasks = await response.json();

      // create kanban category columns
      columns = document.getElementById('columns');

      var orderNumber = 0;
      
      kanbanTasks["statuses"].forEach(function (stat) {
        const columnElement = document.createElement('div');

        columnElement.className = "m-2 p-2 rounded-xl  min-w-48 max-w-80 flex-none ";
        // you can't directly edit a class element to dynamically change the background color
        columnElement.style.backgroundColor = '#'+stat["color"]

        const titleElement = document.createElement('div');
        titleElement.className = "font-bold text-md sm:text-2xl py-2 text-wrap";
        titleElement.innerText = stat["name"];

        const taskDropZone = document.createElement('div');
        taskDropZone.id = stat["name"];
        taskDropZone.className = "overflow-y-auto h-[70dvh] ";
        taskDropZone.setAttribute('ondrop', 'drop(event, this)');
        taskDropZone.setAttribute('ondragover', 'allowDrop(event, this)');
        taskDropZone.setAttribute('statusId', stat["id"]);

        kanbanTasks["taskLists"][orderNumber].forEach(function (task) {
          const listLink = document.createElement('a');
          listLink.id = task.id;
          listLink.statusId = task.statusId;
          listLink.textContent = task.name;
          listLink.draggable = 'true';
          listLink.href = `task/${listLink.id}`;
          listLink.setAttribute('ondragstart', 'drag(event)');
          listLink.className = 'block rounded-lg my-2 p-1 hover:bg-neutral-500 bg-neutral-600 text-wrap';
          listLink.setAttribute('priority', task.priority);
          taskDropZone.appendChild(listLink);

        });

        columnElement.appendChild(titleElement);
        columnElement.appendChild(taskDropZone);
        columns.appendChild(columnElement);

        orderNumber++;
      });

    } catch (error) {
      console.error('There has been a problem with fetching projects:', error);
    }
  })()
</script>

<script>
  function allowDrop(allowdropevent) {
    allowdropevent.preventDefault();
  }

  function drag(dragevent) {
    dragevent.dataTransfer.setData("id", dragevent.target.id);
  }

  async function drop(dropevent, element) {
    dropevent.preventDefault();

    const task = document.getElementById(dropevent.dataTransfer.getData("id"));
    try{
    element.appendChild(task);
    const response = await fetch('{{ apiUrl }}/kanban/', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({id: task.id, statusId: element.getAttribute('statusId'), priority: task.getAttribute('priority')})
    });
  }catch(error)
  {
    console.error('There has been a problem with updating the kanban board:', error);
  }
  }
</script>
{% endblock %}