{% extends "project.html" %}
{% load static %}
{% block projectContent %}


{% comment %} <head>
    <!-- TODO use npm nodemanager instead of the headers -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head> {% endcomment %}

{% block taskContent %}{% endblock %}
{% block editProjectContent %}{% endblock %}

<div class = 'text-white h-screen'>

  <div id="kanbanBoards" class='flex justify-center min-h-screen'>

    <div id="columns" class="flex  mx-4  w-full  h-full text-xs sm:text-xl"></div>

  </div>
  
</div> 


<script>
  (async function () {
    try {
      const response = await fetch('{{ apiUrl }}/kanban/?projectID={{projectID}}')
  
      if (!response.ok) throw new Error('Network response was not ok')
      const kanbanTasks = await response.json()

      // create kanban category columns
      columns = document.getElementById('columns')

      var orderNumber = 0
      for (var stat in kanbanTasks["statuses"]) {
        const columnElement = document.createElement('div')
        const bgColor = 'bg-[#' + stat["color"] + ']'
        columnElement.className = "w-1/3 m-2 p-2 rounded-xl " + bgColor

        const titleElement = document.createElement('div')
        titleElement.className = "font-bold text-md sm:text-2xl my-2"
        titleElement.innerText = key

        const taskDropZone = document.createElement('div')
        taskDropZone.id = key
        taskDropZone.className = "overflow-y-auto  h-[75dvh]"
        taskDropZone.setAttribute('ondrop', 'drop(event, this)')
        taskDropZone.setAttribute('ondragover', 'allowDrop(event, this)')

        kanbanTasks["taskList"][orderNumber].forEach(function (task) {
          const listLink = document.createElement('a')
          listLink.id = task.id
          listLink.textContent = task.name
          listLink.draggable = 'true'
          listLink.setAttribute('ondragstart', 'drag(event)')
          listLink.className = 'block rounded-lg my-2 p-1 hover:bg-neutral-500 bg-neutral-600 '
          listLink.setAttribute('priority', task.priority)
          taskDropZone.appendChild(listLink)

        })
        titleElement.appendChild(taskDropZone)
        columnElement.appendChild(titleElement)
        columns.appendChild(columnElement)

        orderNumber++
      }

    } catch (error) {
      console.error('There has been a problem with fetching projects:', error)
    }
  })()
</script>

<script>
  function allowDrop(allowdropevent) {
    allowdropevent.preventDefault();
  }

  function drag(dragevent) {
    dragevent.dataTransfer.setData("id", dragevent.target.id);
  }

  async function drop(dropevent, element) {
    dropevent.preventDefault();

    const task = document.getElementById(dropevent.dataTransfer.getData("id"));
    try{
    element.appendChild(task);
    const response = await fetch('{{ apiUrl }}/kanban/', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({id: task.id, status: element.id, priority: task.getAttribute('priority')})
    });
  }catch(error)
  {
    console.error('There has been a problem with updating the kanban board:', error);
  }
  }
</script>
{% endblock %}