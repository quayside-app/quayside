{% extends baseTemplate %}
{% load static %}

{% block taskContent %}

<div class="absolute bg-black w-full h-full px-3  bg-opacity-75  text-white svgSizing">
    <div class=" relative  w-full  sm:mx-auto sm:w-96 md:[w-45rem] lg:w-[50rem] bg-neutral-800  p-4 mt-8 sm:p-5  rounded-lg sm:text-xl">

        <form action="{{submitLink}}" method="post">
            {% csrf_token %}

            <div class="flex justify-end">
                <a class=" hover:text-gray-500" href="{{exitLink}}">✕</a> <!-- Go home if exit -->
            </div>

            <div>

                <!-- Manually render form for formatting to take effect -->

                {{ form.name }}
                {{ form.status }}
                <div class="pt-3 sm:pt-0 sm:inline sm:pl-2"> {{ form.startDate }} - {{ form.endDate }} </div>

				<div class="mt-2 text-white"> 
                    <span class="mr-2">Estimated Duration: </span>
                    {{ form.duration }}
                </div>


                {{ form.description }}

                <div class="flex {% if deleteLink %} justify-between {% else %} justify-end {% endif %}">
                    <!-- Delete Button -->
                    {% if deleteLink %}
                    <button type="button" id="deleteTaskButton" class="mt-4 px-2 py-1 rounded-md  text-white bg-neutral-600 hover:bg-red-500 text-center">
                        {% include "components/svg/delete.svg" %}
                    </button>
                    {% endif %}

                    <!-- Save Button -->
                    <button type='submit' class="mt-4 px-2 py-1 rounded-md  text-white bg-neutral-600 hover:bg-gray-500 text-center">
                        Save
                    </button>

                </div>
            </div>
        </form>
        
        <div id="confirmDeleteTaskModal" class="hidden absolute w-64 -bottom-5 left-6 z-50  text-white text-center bg-neutral-800 rounded-lg  text-base">
            <button id="cancelDeleteTaskButton" class="hover:text-gray-500  flex justify-end px-3 pt-3 w-full">
                ✕
            </button>

            <div>Are you sure?</div>

            <button id="deleteTask" class="w-56 m-2 px-2 py-1  rounded-md bg-red-500 hover:bg-red-400">
                Yes, delete this task.
            </button>

            <button id="deleteTaskAndChildren" class="w-56 m-2 px-2 py-1  rounded-md bg-red-500 hover:bg-red-400">
                Yes, delete this task and ALL its children.
            </button>

        </div>

    </div>

</div>
{% if deleteLink %}

<script>
    /*
    * Confirms delete and deletes task when button is clicked.
    */
    
    document.getElementById('deleteTaskButton').addEventListener('click', async function () {
      document.getElementById('confirmDeleteTaskModal').classList.toggle('hidden')
      document.getElementById('deleteTaskButton').disabled = true
      document.getElementById('deleteTaskButton').classList.toggle('hover:bg-red-500')
    })
    
    document.getElementById('cancelDeleteTaskButton').addEventListener('click', async function () {
      document.getElementById('confirmDeleteTaskModal').classList.toggle('hidden')
      document.getElementById('deleteTaskButton').disabled = false
      document.getElementById('deleteTaskButton').classList.toggle('hover:bg-red-500')
    })
    
    
    document.getElementById('deleteTask').addEventListener('click', async function () {
        try {
            event.preventDefault()
            const response = await fetch('{{apiUrl}}/tasks/?id={{taskID}}', { method: 'DELETE' })

            if (!response.ok) {
            const errorData = await response.json()
            throw new Error(errorData.message || 'Network response was not ok')
            }

            // Navigate to project after deleting
            window.location.href = '{{deleteLink}}'
        } catch (error) {
            // Handle network errors
            console.error('There was a problem deleting the task:', error.message)
            alert('There was a problem with your task deletion.') // TODO DO SOMETHING ELSE INSTEAD OF THIS
        }
    })

    document.getElementById('deleteTaskAndChildren').addEventListener('click', async function () {
        try {
            event.preventDefault()
            const response = await fetch('{{apiUrl}}/tasks/?id={{taskID}}&deleteChildren=true', { method: 'DELETE' })

            if (!response.ok) {
            const errorData = await response.json()
            throw new Error(errorData.message || 'Network response was not ok')
            }

            // Navigate to project after deleting
            window.location.href = '{{deleteLink}}'
        } catch (error) {
            // Handle network errors
            console.error('There was a problem deleting the task and its children :', error.message)
            alert('There was a problem with your task deletion.') // TODO DO SOMETHING ELSE INSTEAD OF THIS
        }
    })

    </script>
{% endif %}

{% endblock %}